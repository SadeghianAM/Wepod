<div dir="rtl">

---

# چک‌لیست کامل بهبود پروژه

این سند، یک چک‌لیست جامع برای بازبینی و بهبود یک پروژه وب با تمرکز بر امنیت، ساختار کد، پیکربندی، تجربه کاربری و عملیات است. هر آیتم شامل یک **شرط پذیرش** مشخص برای تأیید صحت پیاده‌سازی است.

---

## 🛡️ ۱. امنیت (بحرانی)

### ۱.۱. جداسازی داده‌های حساس از وب‌روت
- **اقدام:** انتقال پوشه `/data` به مسیری خارج از دایرکتوری عمومی وب (مثلاً `/storage`). اگر انتقال ممکن نیست، دسترسی مستقیم به این پوشه از طریق وب‌سرور (مثلاً با `deny all`) مسدود شود.
- > **شرط پذیرش:** هرگونه درخواست مستقیم به آدرس `/data/...` باید با خطای `403 Forbidden` یا `404 Not Found` مواجه شود.

### ۱.۲. انتقال کلید JWT به متغیر محیطی (ENV) و چرخش کلید
- **اقدام:** کلید `JWT_SECRET` باید از متغیرهای محیطی خوانده شود و حداقل ۳۲ بایت داده کاملاً تصادفی باشد. پس از تغییر کلید، تمام توکن‌های فعال فعلی باید از طریق انقضا یا قرار گرفتن در لیست سیاه، بی‌اعتبار شوند.
- > **شرط پذیرش:** اپلیکیشن بدون تنظیم متغیر `ENV` باید با خطای `500` متوقف شود. پس از تنظیم کلید جدید در `ENV`، توکن‌های صادرشده با کلید قدیمی باید نامعتبر شناخته شوند.

### ۱.۳. استانداردسازی احراز هویت با Bearer Token
- **اقدام:** تمام عملیات‌هایی که منجر به تغییر وضعیت می‌شوند (POST, PUT, PATCH, DELETE) باید **فقط** از طریق هدر `Authorization: Bearer <token>` احراز هویت شوند و استفاده از کوکی برای این منظور متوقف گردد.
- > **شرط پذیرش:** درخواست `POST` بدون هدر `Bearer` باید خطای `401` دریافت کند. توکن نامعتبر باید منجر به خطای `401` و توکن با نقش ناکافی باید منجر به خطای `403` شود.

### ۱.۴. تعریف واحد نقش‌ها (RBAC) و درج `role` در JWT
- **اقدام:** لیست‌های پراکنده کاربران ادمین حذف شده و یک منبع واحد برای تعریف نقش‌ها (Roles) ایجاد شود. نقش کاربر باید به صورت مستقیم در توکن JWT قرار گیرد تا بررسی آن متمرکز و ساده باشد.
- > **شرط پذیرش:** دسترسی به یک اندپوینت ادمین با توکنِ نقش `user` باید خطای `403` برگرداند، در حالی که با نقش `admin` باید پاسخ `200` دریافت کند.

### ۱.۵. حفاظت در برابر حملات CSRF
- **اقدام:** اگر در بخشی از سیستم هنوز از فرم‌ها و کوکی‌ها برای احراز هویت استفاده می‌شود، باید توکن ضد-CSRF به آن‌ها اضافه شود یا آن مسیرها نیز به احراز هویت `Bearer Token` مهاجرت کنند.
- > **شرط پذیرش:** ارسال درخواست فرم بدون توکن CSRF معتبر باید با خطای `403` مسدود شود.

### ۱.۶. محدودسازی نرخ درخواست (Rate Limiting) و حفاظت از لاگین
- **اقدام:** مکانیزمی برای محدودسازی درخواست‌ها بر اساس IP و نام کاربری (در یک حافظه مشترک مانند Redis) پیاده‌سازی شود. پس از چند تلاش ناموفق برای ورود، از CAPTCHA یا تأخیر تصاعدی استفاده شود.
- > **شرط پذیرش:** پس از `N` بار تلاش ناموفق برای ورود، کاربر باید پاسخ `429 Too Many Requests` دریافت کند یا حساب کاربری او به طور موقت قفل شود.

### ۱.۷. جلوگیری از حملات XSS (ذخیره‌شده و بازتابی)
- **اقدام:** از به‌کارگیری `innerHTML` برای نمایش داده‌های ورودی از سمت کاربر یا مدیر سیستم خودداری شود. به جای آن از `textContent` یا کتابخانه‌هایی که خروجی را به طور خودکار امن (escape) می‌کنند، استفاده شود.
- > **شرط پذیرش:** تزریق کدی مانند `<img src=x onerror=alert(1)>` در فیلدهای ورودی نباید منجر به اجرای اسکریپت در مرورگر شود.

### ۱.۸. مدیریت خطای امن
- **اقدام:** جزئیات فنی خطاها (مانند stack trace یا مسیر فایل‌ها) هرگز نباید در پاسخ به کلاینت بازگردانده شوند. این جزئیات باید فقط در لاگ‌های سمت سرور ثبت شوند.
- > **شرط پذیرش:** در زمان بروز خطا، کاربر یک پیام عمومی (مثلاً "خطای داخلی سرور") مشاهده می‌کند و جزئیات کامل خطا در لاگ سرور ثبت می‌شود.

### ۱.۹. اعتبارسنجی ورودی‌ها
- **اقدام:** تمام ورودی‌ها باید به دقت اعتبارسنجی شوند: محدودیت طول رشته‌ها، بررسی الگو (regex) برای تاریخ و شناسه‌ها، استفاده از لیست مقادیر مجاز (allow-list) و محدودیت اندازه JSON payload.
- > **شرط پذیرش:** ارسال ورودی خارج از محدوده‌های تعریف‌شده باید منجر به خطای `400 Bad Request` همراه با یک پیام کوتاه و واضح شود.

### ۱.۱۰. مدیریت توکن و نشست‌ها
- **اقدام:** طول عمر توکن دسترسی (`access token`) کوتاه باشد (۱۵ تا ۶۰ دقیقه). از `refresh token` با قابلیت چرخش (rotation) و لیست سیاه (blacklist) استفاده شود. پس از تغییر رمز عبور، تمام توکن‌های کاربر باید باطل شوند.
- > **شرط پذیرش:** درخواست با توکن منقضی‌شده باید خطای `401` دریافت کند. استفاده مجدد از یک `refresh token` قدیمی (پس از یک بار استفاده) باید نامعتبر شناخته شود.

### ۱.۱۱. سخت‌سازی دسترسی فایل‌ها و دایرکتوری‌ها
- **اقدام:** قابلیت لیست کردن محتوای دایرکتوری‌ها (`directory listing`) در وب‌سرور غیرفعال شود. سطوح دسترسی فایل‌ها روی `640` و دایرکتوری‌ها روی `750` تنظیم شود و `umask` مناسبی تعریف گردد.
- > **شرط پذیرش:** تلاش برای مشاهده محتوای یک دایرکتوری از طریق مرورگر باید مسدود شود.

---

## 🏗️ ۲. ساختار و کدنویسی

### ۲.۱. ماژول واحد احراز هویت (Auth/JWT)
- **اقدام:** تمام منطق مربوط به اعتبارسنجی توکن، استخراج اطلاعات از آن و بررسی نقش‌ها در یک ماژول متمرکز (مانند یک سرویس یا میان‌افزار) قرار گیرد.
- > **شرط پذیرش:** تمام اندپوینت‌های محافظت‌شده از یک تابع یا میان‌افزار مشترک برای احراز هویت استفاده می‌کنند.

### ۲.۲. ساختار دایرکتوری استاندارد
- **اقدام:** پروژه ساختار دایرکتوری مشخصی را دنبال کند:
  - `/public`: تنها دایرکتوری قابل دسترس از طریق وب.
  - `/app` یا `/src`: کد اصلی اپلیکیشن (کنترلر، سرویس، مدل).
  - `/storage`: فایل‌های خصوصی، لاگ‌ها و داده‌های آپلود شده.
  - `/config`: فایل‌های پیکربندی.
  - `/vendor`: وابستگی‌های Composer.
- > **شرط پذیرش:** وب‌سرور فقط برای سرو کردن محتوای دایرکتوری `/public` پیکربندی شده است.

### ۲.۳. حذف کدهای CSS/JS این‌لاین (Inline)
- **اقدام:** تمام کدهای `style` و `<script>` که به صورت این‌لاین در فایل‌های HTML/PHP نوشته شده‌اند، به فایل‌های `.css` و `.js` مجزا منتقل شوند.
- > **شرط پذیرش:** هیچ کد این‌لاین حیاتی در پروژه وجود ندارد و این کار مسیر را برای پیاده‌سازی CSP امن هموار می‌کند.

### ۲.۴. پیکربندی `BASE_URL`
- **اقدام:** تمام لینک‌ها و درخواست‌ها به صورت نسبی یا بر اساس یک متغیر `BASE_URL` ساخته شوند تا پروژه بتواند در یک زیردامنه یا زیرپوشه نیز به درستی کار کند.
- > **شرط پذیرش:** استقرار پروژه در یک `sub-path` (مانند `example.com/app`) باعث شکسته شدن لینک assetها (CSS, JS, تصاویر) نمی‌شود.

### ۲.۵. استفاده از Repository Pattern برای فایل‌های JSON
- **اقدام:** برای خواندن و نوشتن فایل‌های JSON، یک کلاس Repository ایجاد شود که عملیات را به صورت اتمیک (با `LOCK_EX`) انجام دهد تا از خراب شدن داده در دسترسی‌های همزمان جلوگیری شود.
- > **شرط پذیرش:** دو درخواست نوشتن همزمان به یک فایل، منجر به خراب شدن ساختار JSON آن فایل نمی‌شود.

### ۲.۶. پیاده‌سازی لاگ حسابرسی (Audit Trail)
- **اقدام:** برای تمام عملیات‌های حساس (مانند تغییر داده توسط ادمین)، یک لاگ حسابرسی ثبت شود که شامل چه کسی (Who)، چه زمانی (When) و چه کاری (What) را انجام داده است.
- > **شرط پذیرش:** هر تغییر داده مهم، یک رکورد قابل جست‌وجو در فایل `audit.log` یا جدول مربوطه ایجاد می‌کند.

### ۲.۷. سیاست رمز عبور و هشینگ
- **اقدام:** از توابع استاندارد `password_hash` و `password_verify` استفاده شود. مکانیزم `password_needs_rehash` برای به‌روزرسانی خودکار هش‌های قدیمی پیاده‌سازی گردد.
- > **شرط پذیرش:** کاربری که با یک رمز عبور هش‌شده با الگوریتم قدیمی وارد می‌شود، هش رمز عبور او به صورت خودکار با الگوریتم جدیدتر جایگزین می‌شود.

### ۲.۸. کیفیت کد و تست‌های خودکار
- **اقدام:** ابزارهایی مانند `PHP-CS-Fixer` (برای استاندارد PSR-12)، `PHPStan` (برای تحلیل استاتیک کد) و `PHPUnit` (برای تست‌های واحد) به پروژه اضافه شوند.
- > **شرط پذیرش:** پایپ‌لاین CI برای هر کامیت، تمام بررسی‌های کیفیت کد و تست‌ها را با موفقیت (سبز) اجرا می‌کند.

### ۲.۹. پایپ‌لاین CI/CD
- **اقدام:** یک پایپ‌لاین خودکار (مثلاً با GitHub Actions) برای build، تست و استقرار پروژه راه‌اندازی شود. سکرت‌ها و کلیدها به صورت امن در این فرآیند مدیریت شوند.
- > **شرط پذیرش:** هر Pull Request به صورت خودکار تست می‌شود و merge موفق به شاخه اصلی، منجر به استقرار خودکار در محیط staging یا production می‌شود.

---

## ⚙️ ۳. پیکربندی سرور و سخت‌سازی (Hardening)

### ۳.۱. تنظیم هدرهای امنیتی HTTP
- **اقدام:** هدرهای امنیتی زیر در پاسخ‌های وب‌سرور تنظیم شوند:
  - `Strict-Transport-Security`
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY`
  - `Referrer-Policy: no-referrer`
  - `Permissions-Policy` (متناسب با نیاز)
- > **شرط پذیرش:** با استفاده از ابزارهای آنلاین یا DevTools مرورگر، وجود این هدرها در پاسخ‌های سرور تأیید می‌شود.

### ۳.۲. پیاده‌سازی CSP (Content Security Policy)
- **اقدام:** پس از حذف کدهای این‌لاین، یک سیاست CSP سخت‌گیرانه تنظیم شود تا فقط منابع (اسکریپت، استایل، تصویر) از دامنه‌های مجاز بارگذاری شوند.
- > **شرط پذیرش:** صفحات وب بدون هیچ خطایی در کنسول مرورگر رندر می‌شوند و گزارش نقض CSP صفر است.

### ۳.۳. محدودسازی CORS
- **اقدام:** سیاست `Access-Control-Allow-Origin` به جای استفاده از `*` (wildcard)، فقط به دامنه‌های مجاز و مشخص محدود شود.
- > **شرط پذیرش:** درخواست از یک دامنه غیرمجاز توسط مرورگر بلاک می‌شود.

### ۳.۴. تنظیمات PHP برای محیط Production
- **اقدام:** مقادیر زیر در فایل `php.ini` برای محیط پروداکشن تنظیم شوند:
  - `display_errors = Off`
  - `log_errors = On`
  - `expose_php = Off`
  - کوکی‌ها با پرچم‌های `Secure`، `HttpOnly` و `SameSite=Strict` ارسال شوند.
- > **شرط پذیرش:** هیچ خطای PHP در خروجی به کاربر نمایش داده نمی‌شود و اطلاعات نسخه PHP در هدرها وجود ندارد.

### ۳.۵. فایل `robots.txt`
- **اقدام:** فایلی برای جلوگیری از ایندکس شدن مسیرهای حساس (مانند پنل ادمین) توسط موتورهای جست‌وجو ایجاد شود.
- > **شرط پذیرش:** مسیرهای تعریف‌شده در `robots.txt` توسط ابزار Google Search Console به عنوان مسیرهای مسدودشده شناخته می‌شوند.

### ۳.۶. استفاده از Docker/Compose (اختیاری)
- **اقدام:** پروژه با استفاده از Docker کانتینریزه شود تا محیط توسعه و پروداکشن یکسان‌سازی شده و فرآیند استقرار تکرارپذیر و امن‌تر گردد.
- > **شرط پذیرش:** پروژه با یک دستور `docker-compose up` به صورت کامل و بدون نیاز به تنظیمات دستی اجرا می‌شود.

### ۳.۷. پشتیبان‌گیری و چرخش (Backup & Rotation)
- **اقدام:** یک سیاست پشتیبان‌گیری خودکار برای دایرکتوری‌های حساس (مانند `/storage`) تعریف شود که شامل نسخه‌بندی، رمزنگاری و نگهداری برای مدت زمان مشخصی باشد.
- > **شرط پذیرش:** یک فرآیند بازیابی آزمایشی از آخرین نسخه پشتیبان با موفقیت انجام می‌شود.

### ۳.۸. مانیتورینگ و هشدار
- **اقدام:** ابزارهایی برای رصد معیارهای کلیدی (نرخ خطا، تأخیر پاسخ) و ردیابی خطاها (مانند Sentry) به پروژه متصل شوند.
- > **شرط پذیرش:** ایجاد یک خطای آزمایشی به صورت عمدی، بلافاصله در داشبورد مانیتورینگ قابل مشاهده است و یک هشدار ارسال می‌کند.

### ۳.۹. کشینگ امن
- **اقدام:** هدرهای `ETag` و `Cache-Control` برای منابع عمومی تنظیم شوند، اما پاسخ‌های حاوی اطلاعات حساس یا خصوصی هرگز کش نشوند (`Cache-Control: no-store`).
- > **شرط پذیرش:** هدرهای کش برای پاسخ‌های عمومی و خصوصی به درستی و متناسب با محتوای آن‌ها تنظیم شده‌اند.

---

## 🎨 ۴. فرانت‌اند و تجربه کاربری (UX)

### ۴.۱. ماژولارسازی کدهای جاوااسکریپت
- **اقدام:** کدهای JS به ماژول‌های کوچک و با مسئولیت واحد تقسیم شوند (مثلاً ماژول API، ماژول رندر، ماژول ابزارها).
- > **شرط پذیرش:** فایل‌ها کوچک‌تر، خواناتر و قابل تست‌تر شده‌اند.

### ۴.۲. ایمن‌سازی رندرینگ در سمت کلاینت
- **اقتام:** برای نمایش تمام داده‌های داینامیک در فرانت‌اند، از `textContent` یا ابزارهای مدرنی که به طور پیش‌فرض خروجی را امن می‌کنند، استفاده شود.
- > **شرط پذیرش:** تست‌های تزریق اسکریپت (XSS) در سمت کلاینت با شکست مواجه می‌شوند.

### ۴.۳. بهبود دسترس‌پذیری (Accessibility)
- **اقدام:** ویژگی `alt` برای تصاویر، استایل واضح برای حالت `focus`، استفاده از نقش‌های ARIA و رعایت کنتراست رنگ مناسب در دستور کار قرار گیرد.
- > **شرط پذیرش:** امتیاز Lighthouse در بخش Accessibility (A11y) بالاتر از ۹۰ باشد.

### ۴.۴. بهینه‌سازی عملکرد
- **اقدام:** فایل‌های CSS و JS فشرده و باندل شوند، فونت‌ها `preload` شوند، تصاویر به صورت `lazy-load` بارگذاری شوند و فشرده‌سازی `gzip` یا `brotli` در سرور فعال شود.
- > **شرط پذیرش:** امتیاز Lighthouse در بخش Performance بالاتر از ۹۰ باشد.

### ۴.۵. بین‌المللی‌سازی و پشتیبانی از RTL
- **اقدام:** قالب‌بندی تاریخ و اعداد بر اساس زبان کاربر انجام شود و استایل‌های لازم برای پشتیبانی کامل از زبان‌های راست‌به‌چپ (RTL) مانند فارسی اضافه گردد.
- > **شرط پذیرش:** با تغییر زبان به فارسی، چیدمان صفحه بدون به‌هم‌ریختگی به صورت RTL نمایش داده می‌شود.

### ۴.۶. پیام‌های خطای کاربرپسند و حالت آفلاین (اختیاری)
- **اقدام:** به جای نمایش خطاهای فنی، پیام‌های قابل فهم به کاربر نمایش داده شود. در صورت نیاز، یک Service Worker ساده برای نمایش یک صفحه fallback در حالت آفلاین پیاده‌سازی شود.
- > **شرط پذیرش:** در زمان قطع اینترنت، اپلیکیشن یک تجربه کاربری قابل قبول ارائه می‌دهد.

---

## 🧪 ۵. تست، عملیات و مستندسازی

### ۵.۱. تست‌های یکپارچه (Integration Tests) برای مسیرهای حساس
- **اقدام:** سناریوهای کلیدی امنیتی مانند درخواست بدون توکن، با توکن منقضی، با نقش ناکافی و با ورودی نامعتبر به صورت تست‌های خودکار پوشش داده شوند.
- > **شرط پذیرش:** تمام تست‌های یکپارچه در پایپ‌لاین CI با موفقیت اجرا می‌شوند.

### ۵.۲. اسکن‌های امنیتی پایه
- **اقدام:** با استفاده از ابزارهایی مانند OWASP ZAP یا اسکنرهای آنلاین، پروژه برای آسیب‌پذیری‌های رایج (مانند تنظیمات نادرست هدرها) اسکن شود.
- > **شرط پذیرش:** اسکن امنیتی هیچ آسیب‌پذیری با درجه اهمیت بالا (High/Critical) گزارش نمی‌کند.

### ۵.۳. مستندسازی فرآیندهای امنیتی (Runbook)
- **اقدام:** فرآیندهایی مانند چرخش کلیدهای JWT یا ابطال اضطراری توکن‌ها مستند شوند تا در شرایط بحرانی، هر عضوی از تیم بتواند آن‌ها را اجرا کند.
- > **شرط پذیرش:** یک شخص دیگر با دنبال کردن مستندات، می‌تواند فرآیند چرخش کلید را با موفقیت انجام دهد.

### ۵.۴. به‌روزرسانی `README.md` و `env.example`
- **اقدام:** فایل `README` شامل دستورالعمل کامل راه‌اندازی پروژه باشد و فایل `.env.example` تمام متغیرهای محیطی مورد نیاز را لیست کند.
- > **شرط پذیرش:** یک توسعه‌دهنده جدید می‌تواند با پیروی از `README`، پروژه را بدون مشکل روی سیستم خود راه‌اندازی کند.

---

## 🚀 ۶. گام‌های سریع (Quick Wins)

- [ ] **بستن دسترسی HTTP به `/data`** یا انتقال آن به خارج از وب‌روت.
- [ ] **خواندن `JWT_SECRET` از ENV** و تولید یک کلید جدید و امن.
- [ ] **یکپارچه‌سازی نقش‌ها** و افزودن فیلد `role` به توکن JWT.
- [ ] **الزام `Bearer Token`** برای تمام متدهای `POST`/`PUT`/`DELETE`.
- [ ] **جایگزینی `innerHTML` های حساس** با `textContent` یا معادل امن آن.
- [ ] **افزودن هدرهای امنیتی پایه** (HSTS, X-Content-Type-Options, X-Frame-Options).
- [ ] **فعال‌سازی لاگ حسابرسی** برای تغییرات مهم مدیریتی.
- [ ] **خارج کردن CSS/JS این‌لاین** و آماده‌سازی برای پیاده‌سازی CSP.

---

## ✅ چک‌های نهایی (System Acceptance Criteria)

- [ ] درخواست `GET` به یک مسیر حساس بدون توکن با خطای `401` مواجه می‌شود.
- [ ] درخواست به یک مسیر ادمین با توکنِ نقش اشتباه، خطای `403` برمی‌گرداند.
- [ ] تلاش بیش از حد برای لاگین منجر به پاسخ `429` یا قفل موقت حساب می‌شود.
- [ ] تزریق اسکریپت در فیلدهای متنی به صورت خنثی‌شده نمایش داده می‌شود و اجرا نمی‌شود.
- [ ] پاسخ‌های سرور شامل تمام هدرهای امنیتی تعریف‌شده هستند.
- [ ] دسترسی مستقیم به فایل‌های داده از طریق وب غیرممکن است.
- [ ] امتیازهای Lighthouse در بخش‌های عملکرد، دسترس‌پذیری و بهترین شیوه‌ها به حد نصاب رسیده‌اند.
- [ ] تمام تست‌های یونیت و یکپارچه در پایپ‌لاین CI سبز هستند.
