<div dir="rtl">

# چک‌لیست کامل بهبود پروژه (Markdown)

> تِم‌ها: امنیت (بحرانی)، ساختار/کدنویسی، پیکربندی سرور، فرانت‌اند/UX، تست و عملیات.
> هر مورد یک «شرط پذیرش» هم دارد تا مطمئن شوی درست انجام شده.

---

## 1) امنیت (بحرانی)

- [ ] **جدا کردن داده‌های حساس از وب‌روت**
      انتقال `/data` به مسیر خارج از دایرکتوری قابل سرو (مثلاً `/storage`). یا حداقل `deny all` روی وب‌سرور برای `/data`.
      **پذیرش:** درخواست مستقیم به `/data/...` به **403/404** ختم شود.

- [ ] **انتقال کلید JWT به ENV + چرخش کلید (rotate)**
      خواندن `JWT_SECRET` از متغیر محیطی (حداقل 32 بایت رَندُم). همه توکن‌های فعال فعلی را با انقضا/لیست‌سیاه بی‌اعتبار کن.
      **پذیرش:** بدون ENV، اپ با **500** امن می‌میرد؛ با ENV جدید، توکن‌های قدیمی **نامعتبر** می‌شوند.

- [ ] **استانداردسازی احراز هویت با Bearer Token**
      تمام عملیات تغییر وضعیت فقط با هدر `Authorization: Bearer <token>` مجاز باشد (نه کوکی).
      **پذیرش:** POST بدون Bearer → **401**؛ Bearer نامعتبر → **401**؛ نقش ناکافی → **403**.

- [ ] **تعریف واحد نقش‌ها (RBAC) و درج `role` در JWT**
      حذف لیست‌های پراکنده ادمین؛ یک منبع واحد نقش‌ها و چک مرکزی.
      **پذیرش:** endpoint ادمین با نقش `user` → **403**؛ با `admin` → **200**.

- [ ] **CSRF**
      اگر جایی هنوز فرم/کوکی استفاده می‌شود: توکن CSRF اضافه شود یا آن مسیر هم به Bearer مهاجرت کند.
      **پذیرش:** درخواست فرم بدون CSRF → **403**.

- [ ] **Rate limiting و حفاظت از لاگین**
      محدودسازی بر اساس **IP + username** در استوری مشترک (Redis/DB) + CAPTCHА/تأخیر تصاعدی بعد از چند تلاش.
      **پذیرش:** بعد از N تلاش ناموفق، پاسخ **429** یا قفل موقت.

- [ ] **XSS (بازتابی/ذخیره‌شده)**
      حذف `innerHTML` برای داده‌های کاربر/مدیر؛ استفاده از `textContent` یا escape کردن.
      **پذیرش:** تزریق `<img src=x onerror=alert(1)>` در داده‌ها باعث اجرای اسکریپت **نمی‌شود**.

- [ ] **مدیریت خطا**
      عدم بازگشت استک‌تریس/مسیر فایل به کلاینت؛ ثبت جزئیات در لاگ سرور.
      **پذیرش:** در حالت خطا، پیام عمومی (مثلاً “خطای داخلی”) و لاگ داخلی حاوی جزئیات.

- [ ] **اعتبارسنجی ورودی**
      محدودیت طول فیلدها، الگوهای تاریخ/آیدی، allow-list، و سایز JSON.
      **پذیرش:** ورودی خارج از محدوده‌ها → **400** با پیام کوتاه.

- [ ] **توکن و نشست‌ها**
      `exp` کوتاه (۱۵–۶۰ دقیقه)، رفرش‌توکن با چرخش و لیست‌سیاه؛ ابطال همه توکن‌ها بعد از تغییر پسورد.
      **پذیرش:** توکن منقضی → **401**؛ رفرش قدیمی بعد از استفاده → **نامعتبر**.

- [ ] **سخت‌سازی فایل/دایرکتوری**
      غیرفعال‌کردن directory listing؛ سطح دسترسی 750/640 برای دایرکتوری/فایل، `umask` مناسب.
      **پذیرش:** لیست‌برداری دایرکتوری از وب ممکن **نیست**.

---

## 2) ساختار و کدنویسی

- [ ] **یک ماژول واحد Auth/JWT**
      تمام verify/parse/role-check در `auth.php` (یا سرویس معادل) متمرکز. Polyfill برای `getallheaders`.
      **پذیرش:** همه endpointها از یک تابع/میان‌افزار مشترک استفاده می‌کنند.

- [ ] **ساختار دایرکتوری حرفه‌ای**

  ```
  /public  ← فقط قابل سرو
  /app     ← کد PHP (کنترلر/سرویس/هلپر)
  /storage ← داده خصوصی و لاگ
  /config  ← env/تنظیمات
  /vendor  ← Composer
  ```

  **پذیرش:** وب‌سرور فقط `/public` را سرو می‌کند.

- [ ] **حذف CSS/JS این‌لاین**
      انتقال به فایل‌های مجزا؛ آماده‌سازی برای CSP بدون `'unsafe-inline'`.
      **پذیرش:** هیچ `style=` و `<script>` این‌لاین حیاتی وجود ندارد.

- [ ] **پیکربندی `BASE_URL`**
      لینک‌ها/درخواست‌ها نسبی یا مبتنی بر `BASE_URL` تا در ساب‌پث هم کار کند.
      **پذیرش:** دیپلوی در ساب‌پث بدون شکستن assetها.

- [ ] **Repository برای فایل‌های JSON**
      خواندن/نوشتن اتمیک با `LOCK_EX`، محدودیت اندازه، نسخه‌گذاری ساده.
      **پذیرش:** نوشتن همزمان به خراب‌شدن فایل منجر **نمی‌شود**.

- [ ] **لاگ و Audit Trail**
      ثبت `who/when/what` برای تغییرات (مثلاً `storage/audit.log`).
      **پذیرش:** هر تغییر رکورد audit دارد و قابل جست‌وجوست.

- [ ] **هش و سیاست پسورد**
      `password_needs_rehash` و سیاست طول/پیچیدگی/حداکثر عمر.
      **پذیرش:** لاگین موفق قدیمی → ریهش خودکار ذخیره می‌شود.

- [ ] **کیفیت کد و تست**
      PSR-12 (PHPCS یا PHP-CS-Fixer)، PHPStan (≥ لِول 5)، PHPUnit برای یونیت‌تست.
      **پذیرش:** CI سبز با lint+static analysis+tests.

- [ ] **Pipeline CI/CD**
      GitHub Actions برای build/test، و دیپلوی امن (بدون نشت سِکرِت‌ها).
      **پذیرش:** هر PR به صورت خودکار lint/test می‌شود.

---

## 3) پیکربندی سرور و هاردنینگ

- [ ] **HTTP Security Headers**

  - `Strict-Transport-Security` (فقط روی HTTPS)،
  - `X-Content-Type-Options: nosniff`,
  - `X-Frame-Options: DENY`,
  - `Referrer-Policy: no-referrer`,
  - `Permissions-Policy` متناسب.
    **پذیرش:** پاسخ‌ها شامل هدرهای فوق هستند.

- [ ] **CSP (پس از حذف این‌لاین‌ها)**

  ```
  Content-Security-Policy:
    default-src 'self';
    script-src 'self';
    style-src 'self';
    img-src 'self' data:;
  ```

  **پذیرش:** گزارش نقض CSP صفر؛ رندر صفحات بدون ارور.

- [ ] **CORS محدود**
      مبدأهای مجاز مشخص، روش‌های لازم؛ جلوگیری از wildcard.
      **پذیرش:** مبدأهای غیرمجاز → بلاک.

- [ ] **تنظیمات PHP برای پروڈاکشن**
      `display_errors=Off`, `log_errors=On`, `expose_php=Off`, کوکی‌ها با `Secure` و `SameSite=Strict`.
      **پذیرش:** خطاها فقط در لاگ، نه در پاسخ.

- [ ] **Robots و مسیردهی**
      `robots.txt` برای جلوگیری از ایندکس `/admin` و مسیرهای حساس (امنیتی نیست، پیشگیرانه است).
      **پذیرش:** مسیرهای ادمین ایندکس نمی‌شوند.

- [ ] **Docker/Compose (اختیاری اما توصیه‌شده)**
      nginx + php-fpm، تزریق ENV در دیپلوی، بدون bake کردن سِکرِت‌ها در ایمیج.
      **پذیرش:** محیط dev/prod یکسان‌تر؛ build تکرارپذیر.

- [ ] **Backup & Rotation**
      پالیسی بکاپ برای `/storage` (نسخه‌گذاری، نگهداری N روزه، رمزنگاری در مقصد).
      **پذیرش:** بازیابی آزمایشی موفق.

- [ ] **مانیتورینگ و هشدار**
      متریک‌ها (Latency/4xx/5xx، نرخ لاگین ناموفق)، error tracking (مثلاً Sentry).
      **پذیرش:** خطای عمدی تستی در داشبورد قابل مشاهده است.

- [ ] **کشینگِ امن**
      ETag/Cache-Control برای JSONهای عمومی؛ عدم کش پاسخ‌های احراز هویت‌شده.
      **پذیرش:** هدرهای کش بر اساس نوع پاسخ درست‌اند.

---

## 4) فرانت‌اند و UX

- [ ] **ماژولارسازی JS**
      جداکردن لایه fetch، رندر، و utility (escape/formatDate).
      **پذیرش:** فایل‌ها کوچک‌تر و قابل تست.

- [ ] **ایمن‌سازی رندر**
      استفاده از `textContent`/DOM API یا escape برای تمام داده‌های پویا.
      **پذیرش:** تست XSS عبور نمی‌کند.

- [ ] **دسترس‌پذیری**
      alt برای تصاویر/آیکون‌ها، فوکوس‌استایل واضح، ARIA مناسب، کنتراست رنگ.
      **پذیرش:** Lighthouse A11y ≥ 90.

- [ ] **بهینه‌سازی عملکرد**
      Minify/Bundle، preload فونت، lazy-load تصاویر، gzip/brotli.
      **پذیرش:** Lighthouse Performance ≥ 90.

- [ ] **بین‌المللی‌سازی/RTL**
      قالب‌بندی تاریخ/عددی و پشتیبانی کامل RTL.
      **پذیرش:** نمایش فارسی بدون به‌هم‌ریختگی.

- [ ] **خطای کاربرپسند و آفلاین (اختیاری)**
      نمایش پیام مناسب روی خطاها؛ (در صورت نیاز) Service Worker سبک برای fallback.
      **پذیرش:** قطع اینترنت → تجربه قابل‌قبول.

---

## 5) تست، امن‌بودن تغییرات و مستندسازی

- [ ] **تست‌های یکپارچه برای مسیرهای حساس**
      سناریوهای: بدون توکن/توکن منقضی/نقش ناکافی/ورودی بد.
      **پذیرش:** همه تست‌ها سبز.

- [ ] **اسکن‌های امنیتی پایه**
      بررسی هدرها، CSP، XSS، CSRF با ابزارهایی مثل OWASP ZAP.
      **پذیرش:** بدون High/Critical.

- [ ] **Runbook کلیدها و روتیشن**
      مستند چرخش JWT/رفرش‌توکن، ابطال اضطراری.
      **پذیرش:** شخص دیگری با پیروی از مستند می‌تواند روتیشن را انجام دهد.

- [ ] **README و .env.example**
      توضیح راه‌اندازی، متغیرهای محیطی، دسترسی‌ها.
      **پذیرش:** نصب از صفر طبق README بی‌دردسر انجام می‌شود.

---

## 6) «گام‌های سریع» (Quick Wins برای شروع)

- [ ] بستن دسترسی HTTP به `/data` یا انتقال آن به `/storage`.
- [ ] خواندن `JWT_SECRET` از ENV + تولید کلید جدید و rotate.
- [ ] یکپارچه‌سازی نقش‌ها و افزودن `role` به JWT.
- [ ] الزام Bearer برای همه POST/PUT/PATCH/DELETE.
- [ ] جایگزینی همه `innerHTML`‌های حساس با `textContent`/escape.
- [ ] افزودن هدرهای امنیتی پایه (HSTS, X-CTO, X-Frame-Options, Referrer-Policy).
- [ ] فعال کردن لاگ و `audit.log` برای تغییرات مدیریتی.
- [ ] خروج CSS/JS از این‌لاین و آماده‌سازی CSP.

---

## چک‌های نهایی (قبولی سیستم)

- [ ] درخواست GET به مسیر حساس بدون توکن → **401**.
- [ ] درخواست با نقش اشتباه به مسیر ادمین → **403**.
- [ ] تلاش لاگین بیش از حد → **429** یا قفل موقت.
- [ ] تزریق اسکریپت در فیلدهای متنی → **نمایش خنثی‌شده** (بدون اجرا).
- [ ] پاسخ‌ها شامل هدرهای امنیتی تعریف‌شده هستند.
- [ ] دسترسی مستقیم به فایل‌های داده از وب غیرممکن است.
- [ ] Lighthouse (Perf/A11y/Best Practices/Security) امتیازهای هدف را می‌گیرد.
- [ ] تست‌های یونیت/یکپارچه CI همگی سبز هستند.
