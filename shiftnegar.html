<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>برنامه شیفت‌ها</title>
    <style>
      /* --- START: ORIGINAL STYLES (UNCHANGED) --- */
      :root {
        --primary-color: #00ae70;
        --primary-dark: #089863;
        --primary-light: #e6f7f2;
        --bg-color: #f8fcf9;
        --text-color: #222;
        --secondary-text-color: #555;
        --card-bg: #ffffff;
        --header-text: #ffffff;
        --shadow-color-light: rgba(0, 174, 112, 0.07);
        --shadow-color-medium: rgba(0, 174, 112, 0.12);
        --border-radius: 0.75rem;
        --border-color: #e9e9e9;
      }
      @font-face {
        font-family: "Vazirmatn";
        src: url("/assets/fonts/Vazirmatn[wght].ttf") format("truetype");
        font-weight: 100 900;
        font-display: swap;
      }
      *,
      *::before,
      *::after {
        font-family: "Vazirmatn", sans-serif !important;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        direction: rtl;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      a {
        text-decoration: none;
        transition: all 0.2s ease-in-out;
      }
      header,
      footer {
        background: var(--primary-color);
        color: var(--header-text);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px var(--shadow-color-light);
        position: relative;
        z-index: 10;
        flex-shrink: 0;
      }
      header {
        height: 70px;
      }
      header h1 {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0;
        color: var(--header-text);
      }
      footer {
        height: 60px;
        font-size: 0.85rem;
        margin-top: auto;
      }
      main {
        width: 100%;
        flex-grow: 1;
        background-color: var(--card-bg);
        padding: 2rem;
        box-shadow: 0 4px 20px var(--shadow-color-light);
      }
      h1 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: var(--primary-dark);
        text-align: center;
        font-weight: 700;
      }
      .filters-container {
        background-color: #f1f3f5;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        align-items: flex-end;
      }
      .filter-group {
        display: flex;
        flex-direction: column;
      }
      .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      .filter-group input[type="date"],
      .filter-group select {
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        font-size: 1rem;
        width: 100%;
      }
      .filter-group select {
        background-color: var(--card-bg);
      }
      #loader {
        text-align: center;
        font-size: 1.2rem;
        color: var(--secondary-text-color);
        padding: 3rem;
      }
      .table-container {
        width: 100%;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }
      th,
      td {
        padding: 0.9rem 1rem;
        text-align: center;
        border: 1px solid var(--border-color);
        white-space: nowrap;
      }
      thead th {
        background-color: var(--primary-light);
        color: var(--secondary-text-color);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 3;
        line-height: 1.4;
      }
      tbody tr:nth-child(even) {
        background-color: var(--bg-color);
      }
      tbody tr:hover {
        background-color: var(--primary-light);
      }
      thead th:nth-child(1),
      tbody td:nth-child(1) {
        width: 200px;
        min-width: 200px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      thead th:nth-child(2),
      tbody td:nth-child(2) {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
      }
      thead th:nth-child(3),
      tbody td:nth-child(3) {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
      }
      thead th:nth-child(-n + 3),
      tbody td:nth-child(-n + 3) {
        position: -webkit-sticky;
        position: sticky;
        z-index: 2;
      }
      thead th:nth-child(1),
      tbody td:nth-child(1) {
        right: 0;
      }
      thead th:nth-child(2),
      tbody td:nth-child(2) {
        right: 200px;
      }
      thead th:nth-child(3),
      tbody td:nth-child(3) {
        right: 350px;
      }
      thead th:nth-child(-n + 3) {
        background-color: var(--primary-light);
        z-index: 4;
      }
      tbody td:nth-child(-n + 3) {
        background-color: var(--card-bg);
      }
      tbody tr:nth-child(even) td:nth-child(-n + 3) {
        background-color: var(--bg-color);
      }
      tbody tr:hover td:nth-child(-n + 3) {
        background-color: var(--primary-light);
      }
      tbody td:nth-child(1) {
        font-weight: 600;
        text-align: right;
      }
      thead th:nth-child(1)::after,
      tbody td:nth-child(1)::after,
      thead th:nth-child(2)::after,
      tbody td:nth-child(2)::after,
      thead th:nth-child(3)::after,
      tbody td:nth-child(3)::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 3px;
        background-color: var(--primary-dark);
      }
      .status {
        padding: 0.5em 0.7em;
        border-radius: 0.3rem;
        font-weight: 500;
        font-size: 0.85rem;
        color: #fff;
        min-width: 80px;
        display: inline-block;
      }
      .status-on-duty {
        background-color: #28a745;
      }
      .status-off {
        background-color: #dc3545;
      }
      .status-unknown {
        background-color: #6c757d;
      }
      .status-special {
        background-color: #ffc107;
        color: #212529;
      }
      /* --- END: ORIGINAL STYLES --- */

      /* --- START: NEW STYLES FOR TABS AND CALENDAR --- */
      .tabs-container {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
      }
      .tab-button {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: transparent;
        color: var(--secondary-text-color);
        border-bottom: 3px solid transparent;
        transition: color 0.3s, border-color 0.3s;
        margin-left: 1rem;
      }
      .tab-button:hover {
        color: var(--primary-dark);
      }
      .tab-button.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .not-logged-in {
        text-align: center;
        padding: 3rem;
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: var(--border-radius);
      }
      .not-logged-in a {
        color: var(--primary-dark);
        font-weight: bold;
      }
      #user-shift-info {
        background-color: var(--primary-light);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 1rem;
      }
      #user-shift-info span {
        font-weight: 700;
        color: var(--primary-dark);
      }
      #calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      #calendar-controls button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #calendar-controls button:hover {
        background-color: var(--primary-dark);
      }
      #current-month-year {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-dark);
      }
      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        background-color: var(--card-bg);
        padding: 1rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
      }
      .calendar-header {
        text-align: center;
        font-weight: 600;
        padding: 0.8rem 0;
        color: var(--secondary-text-color);
        border-bottom: 2px solid var(--border-color);
      }
      .calendar-day {
        min-height: 120px;
        border: 1px solid #f0f0f0;
        border-radius: 0.5rem;
        padding: 0.5rem;
        font-size: 0.9rem;
        background-color: #fafafa;
        display: flex;
        flex-direction: column;
      }
      .calendar-day.other-month {
        background-color: #f8f9fa;
        color: #ced4da;
        pointer-events: none;
      }
      .calendar-day .shift-info {
        padding: 0.5rem;
        border-radius: 0.3rem;
        color: white;
        text-align: center;
        font-weight: 500;
        margin-top: auto;
      }
      /* --- END: NEW STYLES --- */
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>
    <main>
      <div class="tabs-container">
        <button id="monthly-tab" class="tab-button active">
          برنامه شیفت ماهانه
        </button>
        <button id="my-shift-tab" class="tab-button">شیفت من</button>
      </div>
      <div id="monthly-view" class="tab-content active">
        <h1>برنامه شیفت ماهانه</h1>
        <div class="filters-container">
          <div class="filter-group">
            <label for="startDate">از تاریخ:</label
            ><input type="date" id="startDate" />
          </div>
          <div class="filter-group">
            <label for="endDate">تا تاریخ:</label
            ><input type="date" id="endDate" />
          </div>
          <div class="filter-group">
            <label for="expertSelect1">انتخاب کارشناس اول:</label
            ><select id="expertSelect1"></select>
          </div>
          <div class="filter-group">
            <label for="expertSelect2">انتخاب کارشناس دوم:</label
            ><select id="expertSelect2"></select>
          </div>
        </div>
        <div id="loader">در حال بارگذاری اطلاعات...</div>
        <div id="schedule-container" class="table-container"></div>
      </div>

      <div id="my-shift-view" class="tab-content"></div>
    </main>
    <div id="footer-placeholder"></div>
    <script src="/js/header.js"></script>
    <script>
      // --- GLOBAL VARIABLES ---
      let allExperts = [];
      let allAvailableDates = [];
      let currentCalendarDate = new Date();
      const shiftColorMap = new Map();
      const colorPalette = [
        "#E3F2FD",
        "#E8F5E9",
        "#FFF3E0",
        "#F3E5F5",
        "#FFEBEE",
        "#E0F7FA",
      ];
      let nextColorIndex = 0;

      // --- INITIALIZATION ---
      document.addEventListener("DOMContentLoaded", initializePage);

      async function initializePage() {
        setupTabs();
        const loader = document.getElementById("loader");
        try {
          const response = await fetch(
            "/data/shifts.json?v=" + new Date().getTime()
          );
          if (!response.ok)
            throw new Error(
              `فایل shifts.json یافت نشد (کد: ${response.status})`
            );

          const data = await response.json();
          allExperts = data.experts || [];
          if (allExperts.length === 0) {
            loader.textContent = "هیچ اطلاعاتی برای نمایش وجود ندارد.";
            return;
          }
          populateFilterControls();
          document
            .getElementById("startDate")
            .addEventListener("change", applyFilters);
          document
            .getElementById("endDate")
            .addEventListener("change", applyFilters);
          document
            .getElementById("expertSelect1")
            .addEventListener("change", applyFilters);
          document
            .getElementById("expertSelect2")
            .addEventListener("change", applyFilters);
          applyFilters();
        } catch (error) {
          loader.textContent = `خطا: ${error.message}`;
          loader.style.color = "var(--error-color)";
        }
      }

      // --- TAB MANAGEMENT ---
      function setupTabs() {
        const tabs = document.querySelectorAll(".tab-button");
        const contents = document.querySelectorAll(".tab-content");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((item) => item.classList.remove("active"));
            contents.forEach((content) => content.classList.remove("active"));
            tab.classList.add("active");
            const activeContent = document.getElementById(
              tab.id.replace("-tab", "-view")
            );
            activeContent.classList.add("active");
            if (tab.id === "my-shift-tab") {
              handleMyShiftTabClick();
            }
          });
        });
      }

      // --- "MY SHIFT" CALENDAR LOGIC ---
      function parseJwt(token) {
        try {
          return JSON.parse(atob(token.split(".")[1]));
        } catch (e) {
          return null;
        }
      }

      function handleMyShiftTabClick() {
        const myShiftContainer = document.getElementById("my-shift-view");
        const token = localStorage.getItem("jwt");
        if (!token) {
          myShiftContainer.innerHTML = `<div class="not-logged-in"><p>برای مشاهده شیفت شخصی خود، لطفاً ابتدا وارد شوید.</p><a href="/login.html">رفتن به صفحه ورود</a></div>`;
          return;
        }
        const tokenPayload = parseJwt(token);
        const userId = tokenPayload ? tokenPayload.id : null; // Reads 'id' directly from payload
        if (!userId) {
          myShiftContainer.innerHTML = `<div class="not-logged-in"><p>اطلاعات کاربری در توکن شما یافت نشد. لطفاً دوباره وارد شوید.</p><a href="/login.html">خروج و ورود مجدد</a></div>`;
          return;
        }
        const userShiftData = allExperts.find((expert) => expert.id == userId);
        if (!userShiftData) {
          myShiftContainer.innerHTML = `<div class="not-logged-in"><p>اطلاعات شیفت برای شما در سیستم یافت نشد.</p></div>`;
          return;
        }
        renderMyShiftView(userShiftData);
      }

      function renderMyShiftView(userData) {
        const container = document.getElementById("my-shift-view");
        const monthName = currentCalendarDate.toLocaleDateString("fa-IR", {
          month: "long",
        });
        const year = currentCalendarDate.toLocaleDateString("fa-IR", {
          year: "numeric",
        });
        container.innerHTML = `
            <h1>تقویم شیفت من</h1>
            <div id="user-shift-info">
                <p>کارشناس: <span>${userData.name}</span></p>
                <p>ساعت شیفت: <span>${
                  userData["shifts-time"] || "تعیین نشده"
                }</span></p>
                <p>ساعت استراحت: <span>${
                  userData["break-time"] || "تعیین نشده"
                }</span></p>
            </div>
            <div id="calendar-controls">
                <button id="next-month">ماه بعد &larr;</button>
                <span id="current-month-year">${monthName} ${year}</span>
                <button id="prev-month">&rarr; ماه قبل</button>
            </div>
            <div id="calendar-container"></div>`;
        document.getElementById("prev-month").addEventListener("click", () => {
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
          renderMyShiftView(userData);
        });
        document.getElementById("next-month").addEventListener("click", () => {
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
          renderMyShiftView(userData);
        });
        renderCalendar(
          currentCalendarDate.getFullYear(),
          currentCalendarDate.getMonth(),
          userData.shifts
        );
      }

      function renderCalendar(year, month, shiftsData) {
        const container = document.getElementById("calendar-container");
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const weekDays = [
          "شنبه",
          "یکشنبه",
          "دوشنبه",
          "سه‌شنبه",
          "چهارشنبه",
          "پنجشنبه",
          "جمعه",
        ];
        let html = '<div id="calendar-grid">';
        weekDays.forEach(
          (day) => (html += `<div class="calendar-header">${day}</div>`)
        );
        let startOffset = (firstDayOfMonth.getDay() + 1) % 7;
        for (let i = 0; i < startOffset; i++) {
          html += '<div class="calendar-day other-month"></div>';
        }
        for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
          const currentDate = new Date(year, month, day);
          const dateString = currentDate.toISOString().split("T")[0];
          const status = shiftsData[dateString] || "unknown";
          let statusClass = "status-special",
            statusText = status;
          if (status === "on-duty") {
            statusClass = "status-on-duty";
            statusText = "حضور";
          } else if (status === "off") {
            statusClass = "status-off";
            statusText = "عدم حضور";
          } else if (status === "unknown") {
            statusClass = "status-unknown";
            statusText = "";
          }
          html += `<div class="calendar-day">
                        <div class="day-number">${currentDate.toLocaleDateString(
                          "fa-IR",
                          { day: "numeric" }
                        )}</div>
                        ${
                          statusText
                            ? `<div class="shift-info ${statusClass}">${statusText}</div>`
                            : ""
                        }
                     </div>`;
        }
        html += "</div>";
        container.innerHTML = html;
      }

      // --- ORIGINAL FUNCTIONS (UNCHANGED) ---
      function getShiftStyle(shiftTime) {
        if (!shiftTime) {
          return "";
        }
        if (!shiftColorMap.has(shiftTime)) {
          shiftColorMap.set(shiftTime, colorPalette[nextColorIndex]);
          nextColorIndex = (nextColorIndex + 1) % colorPalette.length;
        }
        return `style="background-color: ${shiftColorMap.get(shiftTime)};"`;
      }
      function populateFilterControls() {
        const t = document.getElementById("expertSelect1"),
          e = document.getElementById("expertSelect2");
        let l = '<option value="none">-- هیچکدام --</option>';
        allExperts.forEach((t) => {
          l += `<option value="${t.id}">${t.name}</option>`;
        }),
          (t.innerHTML = l),
          (e.innerHTML = l),
          (t.value = "none"),
          (e.value = "none");
        const n = new Set();
        allExperts.forEach((t) => {
          Object.keys(t.shifts).forEach((t) => n.add(t));
        }),
          (allAvailableDates = Array.from(n).sort()),
          allAvailableDates.length > 0 &&
            ((document.getElementById("startDate").value =
              allAvailableDates[0]),
            (document.getElementById("endDate").value =
              allAvailableDates[allAvailableDates.length - 1]));
      }
      function applyFilters() {
        const t = document.getElementById("startDate").value,
          e = document.getElementById("endDate").value,
          l = document.getElementById("expertSelect1").value,
          n = document.getElementById("expertSelect2").value,
          o = new Set();
        "none" !== l && o.add(l), "none" !== n && o.add(n);
        const a = allAvailableDates.filter((l) => l >= t && l <= e);
        let r =
          o.size > 0 ? allExperts.filter((t) => o.has(t.id)) : [...allExperts];
        r.sort((t, e) =>
          (t["shifts-time"] || "").localeCompare(e["shifts-time"] || "")
        ),
          renderTable(r, a);
      }
      function renderTable(t, e) {
        const l = document.getElementById("schedule-container"),
          n = document.getElementById("loader");
        if (!t || 0 === t.length || !e || 0 === e.length)
          return (
            (l.innerHTML = ""),
            (n.textContent = "هیچ داده‌ای مطابق با فیلترهای شما یافت نشد."),
            void (n.style.display = "block")
          );
        let o =
          "<table><thead><tr><th>نام کارشناس</th><th>ساعت شیفت</th><th>تایم استراحت</th>";
        e.forEach((t) => {
          const e = new Date(t),
            l = e.toLocaleDateString("fa-IR", { day: "numeric" }),
            n = e.toLocaleDateString("fa-IR", { month: "short" }),
            a = e.toLocaleDateString("fa-IR", { weekday: "short" });
          o += `<th>${a}<br>${l} ${n}<br><span style="font-size: 0.8rem; color: #6c757d; font-weight: 400;">${t}</span></th>`;
        }),
          (o += "</tr></thead><tbody>"),
          t.forEach((t) => {
            const l = t["shifts-time"],
              n = getShiftStyle(l),
              a = t["break-time"] || "-";
            (o += `<tr><td>${t.name}</td><td ${n}>${
              l || "-"
            }</td><td>${a}</td>`),
              e.forEach((e) => {
                let l = "",
                  n = t.shifts[e] || "unknown";
                "on-duty" === n
                  ? ((l = "status-on-duty"), (n = "حضور"))
                  : "off" === n
                  ? ((l = "status-off"), (n = "عدم حضور"))
                  : "unknown" === n
                  ? ((l = "status-unknown"), (n = "-"))
                  : (l = "status-special"),
                  (o += `<td><span class="status ${l}">${n}</span></td>`);
              }),
              (o += "</tr>");
          }),
          (o += "</tbody></table>"),
          (l.innerHTML = o),
          (n.style.display = "none");
      }
    </script>
  </body>
</html>
