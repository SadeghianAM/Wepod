<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´ÛŒÙØªâ€ŒÙ‡Ø§</title>
    <style>
      :root {
        --primary-color: #00ae70;
        --primary-dark: #089863;
        --primary-light: #e6f7f2;
        --bg-color: #f8fcf9;
        --text-color: #222;
        --secondary-text-color: #555;
        --card-bg: #ffffff;
        --header-text: #ffffff;
        --shadow-color-light: rgba(0, 174, 112, 0.07);
        --shadow-color-medium: rgba(0, 174, 112, 0.12);
        --border-radius: 0.75rem;
        --border-color: #e9e9e9;
        --swap-color: #e8eaf6;
        --swap-text-color: #3f51b5;
      }
      @font-face {
        font-family: "Vazirmatn";
        src: url("/assets/fonts/Vazirmatn[wght].ttf") format("truetype");
        font-weight: 100 900;
        font-display: swap;
      }
      *,
      *::before,
      *::after {
        font-family: "Vazirmatn", sans-serif !important;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        direction: rtl;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      a {
        text-decoration: none;
        transition: all 0.2s ease-in-out;
      }
      header,
      footer {
        background: var(--primary-color);
        color: var(--header-text);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px var(--shadow-color-light);
        position: relative;
        z-index: 10;
        flex-shrink: 0;
      }
      header {
        height: 70px;
      }
      header h1 {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0;
        color: var(--header-text);
      }
      footer {
        height: 60px;
        font-size: 0.85rem;
        margin-top: auto;
      }
      main {
        width: 100%;
        flex-grow: 1;
        background-color: var(--card-bg);
        padding: 2rem;
        box-shadow: 0 4px 20px var(--shadow-color-light);
      }
      h1 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: var(--primary-dark);
        text-align: center;
        font-weight: 700;
      }
      .filters-container {
        background-color: #f1f3f5;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        align-items: flex-end;
      }
      .filter-group {
        display: flex;
        flex-direction: column;
      }
      .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      .filter-group input[type="text"],
      .filter-group select {
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        font-size: 1rem;
        width: 100%;
        background-color: var(--card-bg);
      }
      #loader {
        text-align: center;
        font-size: 1.2rem;
        color: var(--secondary-text-color);
        padding: 3rem;
      }
      .table-container {
        width: 100%;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 960px;
      }
      th,
      td {
        padding: 0.9rem 1rem;
        text-align: center;
        border: 1px solid var(--border-color);
        white-space: nowrap;
      }
      thead th {
        background-color: var(--primary-light);
        color: var(--secondary-text-color);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 3;
        line-height: 1.4;
      }
      tbody tr:nth-child(even) {
        background-color: var(--bg-color);
      }
      tbody tr:hover {
        background-color: var(--primary-light);
      }
      thead th:nth-child(1),
      tbody td:nth-child(1) {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
      }
      thead th:nth-child(2),
      tbody td:nth-child(2) {
        width: 200px;
        min-width: 200px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      thead th:nth-child(3),
      tbody td:nth-child(3) {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
      }
      thead th:nth-child(4),
      tbody td:nth-child(4) {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
      }
      thead th:nth-child(-n + 4),
      tbody td:nth-child(-n + 4) {
        position: sticky;
        z-index: 2;
      }
      thead th:nth-child(1),
      tbody td:nth-child(1) {
        right: 0;
      }
      thead th:nth-child(2),
      tbody td:nth-child(2) {
        right: 60px;
      }
      thead th:nth-child(3),
      tbody td:nth-child(3) {
        right: 260px;
      }
      thead th:nth-child(4),
      tbody td:nth-child(4) {
        right: 410px;
      }
      thead th:nth-child(-n + 4) {
        background-color: var(--primary-light);
        z-index: 4;
      }
      tbody td:nth-child(-n + 4) {
        background-color: var(--card-bg);
      }
      tbody tr:nth-child(even) td:nth-child(-n + 4) {
        background-color: var(--bg-color);
      }
      tbody tr:hover td:nth-child(-n + 4) {
        background-color: var(--primary-light);
      }
      tbody td:nth-child(2) {
        font-weight: 600;
        text-align: right;
      }
      .status {
        padding: 0.5em 0.7em;
        border-radius: 0.3rem;
        font-weight: 500;
        font-size: 0.85rem;
        color: #fff;
        min-width: 80px;
        display: inline-block;
      }
      .status-on-duty {
        background-color: #28a745;
      }
      .status-off {
        background-color: #dc3545;
      }
      .status-unknown {
        background-color: #6c757d;
      }
      .status-special {
        background-color: #ffc107;
        color: #212529;
      }
      .status-swap {
        background-color: var(--swap-color);
        color: var(--swap-text-color);
      }
      .tabs-container {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
      }
      .tab-button {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: transparent;
        color: var(--secondary-text-color);
        border-bottom: 3px solid transparent;
        transition: color 0.3s, border-color 0.3s;
        margin-left: 1rem;
      }
      .tab-button:hover {
        color: var(--primary-dark);
      }
      .tab-button.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .not-logged-in {
        text-align: center;
        padding: 3rem;
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: var(--border-radius);
      }
      .not-logged-in a {
        color: var(--primary-dark);
        font-weight: bold;
      }
      #user-shift-info {
        background-color: var(--primary-light);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 1rem;
      }
      #user-shift-info span {
        font-weight: 700;
        color: var(--primary-dark);
      }
      #calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      #calendar-controls button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s, opacity 0.2s;
      }
      #calendar-controls button:hover {
        background-color: var(--primary-dark);
      }
      #calendar-controls button:disabled {
        background-color: #a5d8d1;
        opacity: 0.6;
        cursor: not-allowed;
      }
      #current-month-year {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-dark);
      }
      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        background-color: var(--card-bg);
        padding: 1rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
      }
      .calendar-header {
        text-align: center;
        font-weight: 600;
        padding: 0.8rem 0;
        color: var(--secondary-text-color);
        border-bottom: 2px solid var(--border-color);
      }
      .calendar-day {
        min-height: 120px;
        border: 1px solid #f0f0f0;
        border-radius: 0.5rem;
        padding: 0.5rem;
        font-size: 0.9rem;
        background-color: #fafafa;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .calendar-day.other-month {
        background-color: #f8f9fa;
        color: #ced4da;
      }
      .calendar-day .shift-info {
        padding: 0.4rem 0.5rem;
        border-radius: 0.3rem;
        color: white;
        text-align: center;
        font-weight: 500;
      }
      /* extra for swap details */
      .shift-info.status-swap {
        color: var(--swap-text-color);
      }
      .swapped-shift-details {
        font-size: 0.8rem;
        background-color: #f0f0f0;
        border-radius: 0.3rem;
        padding: 0.4rem;
        text-align: center;
        color: #333;
        border: 1px solid #ddd;
        line-height: 1.5;
      }
      .jdp-popover {
        position: absolute;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 8px 24px var(--shadow-color-medium);
        padding: 0.75rem;
        width: 280px;
        z-index: 9999;
      }
      .jdp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-weight: 700;
        color: var(--primary-dark);
      }
      .jdp-nav-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 0.25rem 0.6rem;
        border-radius: 0.4rem;
        cursor: pointer;
      }
      .jdp-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .jdp-weekday {
        text-align: center;
        font-size: 0.85rem;
        color: var(--secondary-text-color);
        padding: 0.3rem 0;
      }
      .jdp-day {
        text-align: center;
        padding: 0.4rem 0;
        border-radius: 0.4rem;
        cursor: pointer;
        background: #fafafa;
        border: 1px solid #f0f0f0;
      }
      .jdp-day:hover {
        background: var(--primary-light);
      }
      .jdp-day.other {
        color: #bbb;
        background: #f8f9fa;
      }
      .jdp-hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="header-placeholder"></div>
    <main>
      <div class="tabs-container">
        <button id="monthly-tab" class="tab-button active">
          Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´ÛŒÙØª Ù…Ø§Ù‡Ø§Ù†Ù‡
        </button>
        <button id="my-shift-tab" class="tab-button">Ø´ÛŒÙØª Ù…Ù†</button>
      </div>

      <div id="monthly-view" class="tab-content active">
        <h1>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´ÛŒÙØª Ù…Ø§Ù‡Ø§Ù†Ù‡</h1>
        <div class="filters-container">
          <div class="filter-group">
            <label for="startDate">Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
            <input
              type="text"
              id="startDate"
              placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® (Ø¬Ù„Ø§Ù„ÛŒ)"
              autocomplete="off"
            />
            <input type="hidden" id="startDateAlt" />
          </div>
          <div class="filter-group">
            <label for="endDate">ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
            <input
              type="text"
              id="endDate"
              placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® (Ø¬Ù„Ø§Ù„ÛŒ)"
              autocomplete="off"
            />
            <input type="hidden" id="endDateAlt" />
          </div>
          <div class="filter-group">
            <label for="expertSelect1">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§ÙˆÙ„:</label>
            <select id="expertSelect1"></select>
          </div>
          <div class="filter-group">
            <label for="expertSelect2">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø¯ÙˆÙ…:</label>
            <select id="expertSelect2"></select>
          </div>
        </div>
        <div id="loader">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
        <div id="schedule-container" class="table-container"></div>
      </div>

      <div id="my-shift-view" class="tab-content"></div>
    </main>
    <div id="footer-placeholder"></div>

    <script src="/js/header.js"></script>
    <script>
      let allExperts = [];
      let allAvailableDates = [];
      let currentCalendarDate = new Date();
      const shiftColorMap = new Map();
      const colorPalette = [
        "#E3F2FD",
        "#E8F5E9",
        "#FFF3E0",
        "#F3E5F5",
        "#FFEBEE",
        "#E0F7FA",
      ];
      let nextColorIndex = 0;

      // ============ NEW: auth auth helper ============
      async function getLoggedInUser() {
        try {
          const res = await fetch("/auth/get-user-info.php", {
            credentials: "same-origin",
            headers: { "Cache-Control": "no-store" },
          });
          if (!res.ok) return null;
          const data = await res.json();
          return data && data.ok && data.user ? data.user : null;
        } catch {
          return null;
        }
      }
      // ===================================================

      let startWorkMap = null;
      async function getStartWorkMap() {
        if (startWorkMap) return startWorkMap;
        try {
          const res = await fetch(
            "/data/start-work.json?v=" + new Date().getTime()
          );
          if (!res.ok)
            throw new Error(
              `ÙØ§ÛŒÙ„ start-work.json ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ú©Ø¯: ${res.status})`
            );
          const json = await res.json();
          if (Array.isArray(json)) {
            startWorkMap = new Map(json.map((it) => [String(it.id), it]));
          } else if (json && typeof json === "object" && "id" in json) {
            startWorkMap = new Map([[String(json.id), json]]);
          } else if (json && typeof json === "object") {
            startWorkMap = new Map(
              Object.values(json).map((it) => [String(it.id), it])
            );
          } else {
            startWorkMap = new Map();
          }
        } catch (e) {
          console.error(e);
          startWorkMap = new Map();
        }
        return startWorkMap;
      }

      function diffDaysInclusive(fromDate, toDate) {
        const d1 = new Date(
          fromDate.getFullYear(),
          fromDate.getMonth(),
          fromDate.getDate()
        );
        const d2 = new Date(
          toDate.getFullYear(),
          toDate.getMonth(),
          toDate.getDate()
        );
        const ms = d2 - d1;
        if (ms < 0) return 0;
        return Math.floor(ms / 86400000) + 1;
      }
      function jalaliToGregorian(jy, jm, jd) {
        var sal_a, gy, gm, gd, days;
        jy += 1595;
        days =
          -355668 +
          365 * jy +
          ~~(jy / 33) * 8 +
          ~~(((jy % 33) + 3) / 4) +
          jd +
          (jm < 7 ? (jm - 1) * 31 : (jm - 7) * 30 + 186);
        gy = 400 * ~~(days / 146097);
        days %= 146097;
        if (days > 36524) {
          gy += 100 * ~~(--days / 36524);
          days %= 36524;
          if (days >= 365) days++;
        }
        gy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) {
          gy += ~~((days - 1) / 365);
          days = (days - 1) % 365;
        }
        gd = days + 1;
        sal_a = [
          0,
          31,
          (gy % 4 === 0 && gy % 100 !== 0) || gy % 400 === 0 ? 29 : 28,
          31,
          30,
          31,
          30,
          31,
          31,
          30,
          31,
          30,
          31,
        ];
        for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
        return new Date(gy, gm - 1, gd);
      }
      function toPersian(date) {
        const parts = date.toLocaleDateString("fa-IR-u-nu-latn").split("/");
        return parts.map((p) => parseInt(p, 10));
      }
      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function formatJalaliDisplay(jy, jm, jd) {
        return `${jy}/${pad2(jm)}/${pad2(jd)}`;
      }
      function formatISO(date) {
        return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(
          date.getDate()
        )}`;
      }
      function isJalaliLeap(jy) {
        return (
          ((((((jy - 474) % 2820) + 2820) % 2820) + 474 + 38) * 682) % 2816 <
          682
        );
      }
      function jalaliMonthLength(jy, jm) {
        if (jm <= 6) return 31;
        if (jm <= 11) return 30;
        return isJalaliLeap(jy) ? 30 : 29;
      }

      class JalaliDatePicker {
        constructor(inputId, altId) {
          this.input = document.getElementById(inputId);
          this.alt = document.getElementById(altId);
          if (!this.input || !this.alt) return;
          const gNow = new Date();
          const [jy, jm, jd] = toPersian(gNow);
          this.jy = jy;
          this.jm = jm;
          this.jd = jd;
          this.pop = document.createElement("div");
          this.pop.className = "jdp-popover jdp-hidden";
          document.body.appendChild(this.pop);
          this.boundClickOutside = (e) => {
            if (!this.pop.contains(e.target) && e.target !== this.input) {
              this.hide();
            }
          };
          this.input.addEventListener("focus", () => this.show());
          this.input.addEventListener("click", () => this.show());
          window.addEventListener("resize", () => this.position());
        }
        show() {
          this.render();
          this.position();
          this.pop.classList.remove("jdp-hidden");
          setTimeout(
            () =>
              document.addEventListener("mousedown", this.boundClickOutside),
            0
          );
        }
        hide() {
          this.pop.classList.add("jdp-hidden");
          document.removeEventListener("mousedown", this.boundClickOutside);
        }
        position() {
          const rect = this.input.getBoundingClientRect();
          this.pop.style.top = window.scrollY + rect.bottom + 6 + "px";
          this.pop.style.left = window.scrollX + rect.left + "px";
        }
        nav(delta) {
          this.jm += delta;
          if (this.jm < 1) {
            this.jm = 12;
            this.jy--;
          }
          if (this.jm > 12) {
            this.jm = 1;
            this.jy++;
          }
          this.render();
        }
        render() {
          const weekDays = ["Ø´", "ÛŒ", "Ø¯", "Ø³", "Ú†", "Ù¾", "Ø¬"];
          const firstG = jalaliToGregorian(this.jy, this.jm, 1);
          const firstWeekday = (firstG.getDay() + 1) % 7;
          const daysInMonth = jalaliMonthLength(this.jy, this.jm);
          let html = `<div class="jdp-header"><button class="jdp-nav-btn" data-nav="-1">&rarr;</button><div>${new Intl.DateTimeFormat(
            "fa-IR",
            { month: "long" }
          ).format(firstG)} ${new Intl.DateTimeFormat("fa-IR", {
            year: "numeric",
          }).format(
            firstG
          )}</div><button class="jdp-nav-btn" data-nav="1">&larr;</button></div><div class="jdp-grid">${weekDays
            .map((w) => `<div class="jdp-weekday">${w}</div>`)
            .join("")}`;
          for (let i = 0; i < firstWeekday; i++) {
            html += `<div class="jdp-day other"></div>`;
          }
          for (let d = 1; d <= daysInMonth; d++) {
            html += `<div class="jdp-day" data-day="${d}">${new Intl.NumberFormat(
              "fa-IR"
            ).format(d)}</div>`;
          }
          html += `</div>`;
          this.pop.innerHTML = html;
          this.pop.querySelectorAll("[data-nav]").forEach((btn) => {
            btn.addEventListener("click", (e) =>
              this.nav(parseInt(e.currentTarget.dataset.nav, 10))
            );
          });
          this.pop.querySelectorAll("[data-day]").forEach((cell) => {
            cell.addEventListener("click", (e) => {
              const d = parseInt(e.currentTarget.dataset.day, 10);
              const gDate = jalaliToGregorian(this.jy, this.jm, d);
              this.input.value = formatJalaliDisplay(this.jy, this.jm, d);
              this.alt.value = formatISO(gDate);
              this.hide();
              if (typeof applyFilters === "function") applyFilters();
            });
          });
        }
        setInitialFromGregorian(date) {
          const [jy, jm, jd] = toPersian(date);
          this.jy = jy;
          this.jm = jm;
          this.jd = jd;
          this.input.value = formatJalaliDisplay(jy, jm, jd);
          this.alt.value = formatISO(date);
        }
      }

      document.addEventListener("DOMContentLoaded", initializePage);
      async function initializePage() {
        setupTabs();
        const loader = document.getElementById("loader");
        try {
          const response = await fetch(
            "/data/shifts.json?v=" + new Date().getTime()
          );
          if (!response.ok)
            throw new Error(
              `ÙØ§ÛŒÙ„ shifts.json ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ú©Ø¯: ${response.status})`
            );
          const data = await response.json();
          allExperts = data.experts || [];
          if (allExperts.length === 0) {
            loader.textContent = "Ù‡ÛŒÚ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.";
            return;
          }
          populateFilterControls();
          document
            .getElementById("expertSelect1")
            .addEventListener("change", applyFilters);
          document
            .getElementById("expertSelect2")
            .addEventListener("change", applyFilters);
          applyFilters();
        } catch (error) {
          loader.textContent = `Ø®Ø·Ø§: ${error.message}`;
          loader.style.color = "var(--error-color)";
        }
      }

      function setupTabs() {
        const tabs = document.querySelectorAll(".tab-button");
        const contents = document.querySelectorAll(".tab-content");
        tabs.forEach((tab) => {
          tab.addEventListener("click", async () => {
            tabs.forEach((i) => i.classList.remove("active"));
            contents.forEach((c) => c.classList.remove("active"));
            tab.classList.add("active");
            const activeContent = document.getElementById(
              tab.id.replace("-tab", "-view")
            );
            activeContent.classList.add("active");
            if (tab.id === "my-shift-tab") await handleMyShiftTabClick();
          });
        });
      }

      function hasShiftsInMonth(date, userShifts) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const monthPrefix = `${year}-${month}-`;
        return Object.keys(userShifts).some((shiftDate) =>
          shiftDate.startsWith(monthPrefix)
        );
      }

      // ====== UPDATED: no localStorage/JWT parsing; use auth get-user-info ======
      async function handleMyShiftTabClick() {
        const myShiftContainer = document.getElementById("my-shift-view");
        const user = await getLoggedInUser();

        if (!user) {
          myShiftContainer.innerHTML = `<div class="not-logged-in">
              <p>Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´ÛŒÙØª Ø´Ø®ØµÛŒ Ø®ÙˆØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
              <a href="/auth/login.html">Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯</a>
            </div>`;
          return;
        }

        const userId = user.id ?? user.sub ?? user.userId ?? null;
        let userShiftData = null;

        if (userId !== null) {
          userShiftData = allExperts.find(
            (expert) => String(expert.id) === String(userId)
          );
        }
        // fallback: Ø§Ú¯Ø± Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ username Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if (!userShiftData && user.username) {
          userShiftData = allExperts.find(
            (expert) =>
              String(expert.username || "").toLowerCase() ===
              String(user.username).toLowerCase()
          );
        }

        if (!userShiftData) {
          myShiftContainer.innerHTML = `<div class="not-logged-in">
              <p>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´ÛŒÙØª Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
            </div>`;
          return;
        }

        const swMap = await getStartWorkMap();
        const startInfo = swMap.get(String(userId)) || null;
        renderMyShiftView(userShiftData, startInfo);
      }
      // ============================================================================

      function renderMyShiftView(userData, startInfo) {
        const container = document.getElementById("my-shift-view");
        const monthName = currentCalendarDate.toLocaleDateString("fa-IR", {
          month: "long",
        });
        const year = currentCalendarDate.toLocaleDateString("fa-IR", {
          year: "numeric",
        });
        const prevMonthDate = new Date(currentCalendarDate);
        prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
        const nextMonthDate = new Date(currentCalendarDate);
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
        const hasPrevShifts = hasShiftsInMonth(prevMonthDate, userData.shifts);
        const hasNextShifts = hasShiftsInMonth(nextMonthDate, userData.shifts);

        const breakTime = userData["break-time"];
        let breakLabel = "Ø³Ø§Ø¹Øª Ø§Ø³ØªØ±Ø§Ø­Øª";
        let breakValue = breakTime || "ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡";
        if (breakTime && breakTime.includes(" - ")) {
          const endTime = breakTime.split(" - ")[1].trim();
          if (endTime)
            breakLabel = endTime <= "17:00" ? "ğŸŒ® ØªØ§ÛŒÙ… Ù†Ø§Ù‡Ø§Ø±" : "ğŸŒ® ØªØ§ÛŒÙ… Ø´Ø§Ù…";
        }

        let startWorkText =
          startInfo && startInfo.start_work ? startInfo.start_work : null;
        let startWorkDays = null;
        if (startWorkText) {
          const parts = startWorkText.split("/");
          if (parts.length === 3) {
            const [jy, jm, jd] = parts.map(Number);
            const gStart = jalaliToGregorian(jy, jm, jd);
            startWorkDays = diffDaysInclusive(gStart, new Date());
          }
        }

        container.innerHTML = `
          <h1>ØªÙ‚ÙˆÛŒÙ… Ø´ÛŒÙØª Ù…Ù†</h1>
          <div id="user-shift-info">
            <p>ğŸ‘¤ Ú©Ø§Ø±Ø´Ù†Ø§Ø³: <span>${userData.name}</span></p>
            <p>â° Ø³Ø§Ø¹Øª Ø´ÛŒÙØª: <span>${
              userData["shifts-time"] || "ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡"
            }</span></p>
            <p>${breakLabel}: <span>${breakValue}</span></p>
            ${
              startWorkText
                ? `<p>ğŸ“… Ø¯Ø§ØªÛŒÙ†ÛŒ Ø§Ø² ØªØ§Ø±ÛŒØ®: <span>${startWorkText}</span></p><p><span>ğŸš€ ${(
                    startWorkDays ?? 0
                  ).toLocaleString("fa-IR")}</span> Ø±ÙˆØ²Ù‡ Ú©Ù‡ Ø¯Ø§ØªÛŒÙ†ÛŒ Ù‡Ø³ØªÛŒ</p>`
                : ``
            }
          </div>

          <div id="calendar-controls">
            <button id="prev-month" ${
              hasPrevShifts ? "" : "disabled"
            }>&rarr; Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
            <span id="current-month-year">${monthName} ${year}</span>
            <button id="next-month" ${
              hasNextShifts ? "" : "disabled"
            }>Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ &larr;</button>
          </div>

          <div id="calendar-container"></div>
        `;

        document.getElementById("prev-month").addEventListener("click", () => {
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
          renderMyShiftView(userData, startInfo);
        });
        document.getElementById("next-month").addEventListener("click", () => {
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
          renderMyShiftView(userData, startInfo);
        });

        renderCalendar(currentCalendarDate, userData.shifts);
      }

      function renderCalendar(date, shiftsData) {
        const container = document.getElementById("calendar-container");
        const weekDays = [
          "Ø´Ù†Ø¨Ù‡",
          "ÛŒÚ©Ø´Ù†Ø¨Ù‡",
          "Ø¯ÙˆØ´Ù†Ø¨Ù‡",
          "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡",
          "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡",
          "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡",
          "Ø¬Ù…Ø¹Ù‡",
        ];
        let html = '<div id="calendar-grid">';
        weekDays.forEach(
          (day) => (html += `<div class="calendar-header">${day}</div>`)
        );
        const [pYear, pMonth] = toPersian(date);
        const firstDayOfPersianMonth = jalaliToGregorian(pYear, pMonth, 1);
        const isLeap =
          toPersian(jalaliToGregorian(pYear + 1, 1, 1))[0] - pYear > 1;
        const daysInMonth =
          pMonth < 7 ? 31 : pMonth < 12 ? 30 : isLeap ? 30 : 29;
        const lastDayOfPersianMonth = jalaliToGregorian(
          pYear,
          pMonth,
          daysInMonth
        );
        const calendarStartDate = new Date(firstDayOfPersianMonth);
        const startDayOfWeek = firstDayOfPersianMonth.getDay();
        const offsetToSaturday = (startDayOfWeek + 1) % 7;
        calendarStartDate.setDate(
          calendarStartDate.getDate() - offsetToSaturday
        );
        const calendarEndDate = new Date(lastDayOfPersianMonth);
        const endDayOfWeek = lastDayOfPersianMonth.getDay();
        const offsetToFriday = (5 - endDayOfWeek + 7) % 7;
        calendarEndDate.setDate(calendarEndDate.getDate() + offsetToFriday);
        let loopDate = new Date(calendarStartDate);

        while (loopDate <= calendarEndDate) {
          const [currentPYear, currentPMonth] = toPersian(loopDate);
          const isOtherMonth = currentPMonth !== pMonth;
          const y = loopDate.getFullYear();
          const m = String(loopDate.getMonth() + 1).padStart(2, "0");
          const d = String(loopDate.getDate()).padStart(2, "0");
          const dateString = `${y}-${m}-${d}`;

          const shiftDetails = getShiftDetails(shiftsData[dateString]);
          let statusClass = "";
          let statusText = shiftDetails.displayText;
          let extraDetailsHtml = "";
          if (shiftDetails.isSwap) {
            statusClass = "status-swap";
            if (shiftDetails.displayText.includes("Ø­Ø¶ÙˆØ±")) {
              const originalExpert = allExperts.find(
                (exp) =>
                  String(exp.id) === String(shiftDetails.linkedTo.expertId)
              );
              if (originalExpert) {
                const originalShiftTime =
                  originalExpert["shifts-time"] || "Ù†Ø§Ù…Ø´Ø®Øµ";
                const originalBreakTime =
                  originalExpert["break-time"] || "Ù†Ø§Ù…Ø´Ø®Øµ";
                extraDetailsHtml = `<div class="swapped-shift-details"><div>â° ${originalShiftTime}</div><div>ğŸŒ® ${originalBreakTime}</div></div>`;
              }
            }
          } else {
            const classMap = {
              "on-duty": "status-on-duty",
              off: "status-off",
              leave: "status-special",
              unknown: "status-unknown",
            };
            statusClass = classMap[shiftDetails.status] || "status-special";
          }
          if (shiftDetails.status === "unknown") statusText = "";

          html += `<div class="calendar-day ${
            isOtherMonth ? "other-month" : ""
          }">
              <div class="day-number">${loopDate.toLocaleDateString("fa-IR", {
                day: "numeric",
              })}</div>
              ${
                statusText
                  ? `<div class="shift-info ${statusClass}">${statusText}</div>`
                  : ""
              }
              ${extraDetailsHtml}
            </div>`;
          loopDate.setDate(loopDate.getDate() + 1);
        }
        html += "</div>";
        container.innerHTML = html;
      }

      function getShiftStyle(shiftTime) {
        if (!shiftTime) return "";
        if (!shiftColorMap.has(shiftTime)) {
          shiftColorMap.set(shiftTime, colorPalette[nextColorIndex]);
          nextColorIndex = (nextColorIndex + 1) % colorPalette.length;
        }
        return `style="background-color: ${shiftColorMap.get(shiftTime)};"`;
      }

      function populateFilterControls() {
        const t = document.getElementById("expertSelect1"),
          e = document.getElementById("expertSelect2");
        let l = '<option value="none">-- Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù… --</option>';
        allExperts
          .sort((a, b) => a.name.localeCompare(b.name, "fa"))
          .forEach((t) => {
            l += `<option value="${t.id}">${t.name}</option>`;
          });
        t.innerHTML = l;
        e.innerHTML = l;
        t.value = "none";
        e.value = "none";
        const n = new Set();
        allExperts.forEach((t) => {
          Object.keys(t.shifts).forEach((d) => n.add(d));
        });
        allAvailableDates = Array.from(n).sort();
      }

      function applyFilters() {
        const t = document.getElementById("startDateAlt").value;
        const e = document.getElementById("endDateAlt").value;
        const l = document.getElementById("expertSelect1").value;
        const n = document.getElementById("expertSelect2").value;
        const o = new Set();
        if (l !== "none") o.add(l);
        if (n !== "none") o.add(n);
        const a = allAvailableDates.filter(
          (d) => (!t || d >= t) && (!e || d <= e)
        );
        let r =
          o.size > 0
            ? allExperts.filter((x) => o.has(String(x.id)))
            : [...allExperts];
        r.sort((A, B) => {
          const stA = A["shifts-time"] || "",
            stB = B["shifts-time"] || "";
          const c1 = stA.localeCompare(stB, "fa");
          if (c1 !== 0) return c1;
          const btA = A["break-time"] || "",
            btB = B["break-time"] || "";
          return btA.localeCompare(btB, "fa");
        });
        renderTable(r, a);
      }

      function getShiftDetails(shiftEntry) {
        if (
          typeof shiftEntry === "object" &&
          shiftEntry !== null &&
          shiftEntry.status === "swap"
        ) {
          return {
            status: "swap",
            displayText: shiftEntry.displayText,
            isSwap: true,
            linkedTo: shiftEntry.linkedTo,
          };
        }
        const status = shiftEntry || "unknown";
        let displayText = status;
        switch (status) {
          case "on-duty":
            displayText = "Ø­Ø¶ÙˆØ±";
            break;
          case "off":
            displayText = "Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ±";
            break;
          case "leave":
            displayText = "Ù…Ø±Ø®ØµÛŒ";
            break;
          case "unknown":
            displayText = "-";
            break;
        }
        return { status, displayText, isSwap: false, linkedTo: null };
      }

      function renderTable(expertsToRender, datesToRender) {
        const container = document.getElementById("schedule-container");
        const loader = document.getElementById("loader");
        if (
          !expertsToRender ||
          expertsToRender.length === 0 ||
          !datesToRender ||
          datesToRender.length === 0
        ) {
          container.innerHTML = "";
          loader.textContent = "Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          loader.style.display = "block";
          return;
        }
        loader.style.display = "none";
        let tableHtml = `<table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ø³Ø§Ø¹Øª Ø´ÛŒÙØª</th><th>ØªØ§ÛŒÙ… Ø§Ø³ØªØ±Ø§Ø­Øª</th>`;
        datesToRender.forEach((date) => {
          const d = new Date(date);
          const day = d.toLocaleDateString("fa-IR", { day: "numeric" });
          const month = d.toLocaleDateString("fa-IR", { month: "short" });
          const weekday = d.toLocaleDateString("fa-IR", { weekday: "short" });
          tableHtml += `<th>${weekday}<br>${day} ${month}<br><span style="font-size:.8rem;color:#6c757d;font-weight:400;">${date}</span></th>`;
        });
        tableHtml += "</tr></thead><tbody>";

        expertsToRender.forEach((expert, index) => {
          const shiftTime = expert["shifts-time"] || "-";
          const breakTime = expert["break-time"] || "-";
          const shiftStyle = getShiftStyle(shiftTime);
          tableHtml += `<tr><td>${index + 1}</td><td>${
            expert.name
          }</td><td ${shiftStyle}>${shiftTime}</td><td>${breakTime}</td>`;
          datesToRender.forEach((date) => {
            const shiftDetails = getShiftDetails(expert.shifts[date]);
            let statusClass = "";
            if (shiftDetails.isSwap) {
              statusClass = "status-swap";
            } else {
              const classMap = {
                "on-duty": "status-on-duty",
                off: "status-off",
                leave: "status-special",
                unknown: "status-unknown",
              };
              statusClass = classMap[shiftDetails.status] || "status-special";
            }
            tableHtml += `<td><span class="status ${statusClass}">${shiftDetails.displayText}</span></td>`;
          });
          tableHtml += "</tr>";
        });

        tableHtml += "</tbody></table>";
        container.innerHTML = tableHtml;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);
        const dpStart = new JalaliDatePicker("startDate", "startDateAlt");
        dpStart.setInitialFromGregorian(today);
        const dpEnd = new JalaliDatePicker("endDate", "endDateAlt");
        dpEnd.setInitialFromGregorian(nextWeek);
        document
          .getElementById("startDate")
          .addEventListener("blur", applyFilters);
        document
          .getElementById("endDate")
          .addEventListener("blur", applyFilters);
      });
    </script>
  </body>
</html>
